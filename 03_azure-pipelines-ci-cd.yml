pr:
  branches:
    include:
      - dev
  paths:
    exclude:
      - docs/*
      - README.md

trigger:
  branches:
    include:
      - master
  paths:
    exclude:
      - docs/*
      - README.md
      - 01_azure-pipelines-ci.yml
      - 02_azure-pipelines-ci.yml
      - 03_azure-pipelines-ci-cd.yml

parameters:
  - name: runCompletePipeline
    displayName: Run optional scans? (no Marketplace tasks)
    type: boolean
    default: false

  - name: templateScanEnabled
    displayName: Scan ARM templates via PSRule (no extensions)
    type: boolean
    default: false

variables:
  # Recommended: create a Variable Group in Azure DevOps and store secrets there.
  # Then uncomment the next line and remove hardcoded values below.
  # - group: WebAppWithDatabaseDemo-Secrets

  BuildConfiguration: release

  # Azure DevOps service connection name
  azureSubscription: WebAppWithDatabaseDemo_spn

  # Deployment naming
  Prefix: tunis
  EnvironmentName: dev
  UniqueId: '1280' # consider: $(Build.BuildId)

  ResourceGroupName: $(Prefix)-$(EnvironmentName)-$(UniqueId)-RG
  WebAppName: $(Prefix)-$(EnvironmentName)-$(UniqueId)
  WebAppNameUrl: https://$(WebAppName).azurewebsites.net/
  SqlServerName: $(Prefix)-sql-$(EnvironmentName)-$(UniqueId)
  hostingPlanName: $(Prefix)-service-plan

  Database.Admin: houssem
  Database.Password: '@Aa123456' # to be secured in Key Vault
  Database.Name: EmployeesDB

stages:
  - stage: Build_Stage
    displayName: Build Apps
    jobs:
      - job: WebApp
        displayName: Build Web App
        pool:
          vmImage: windows-2019
        steps:
          - checkout: self

          - task: UseDotNet@2
            displayName: Install .NET 6 SDK
            inputs:
              packageType: sdk
              version: 6.0.x

          - task: DotNetCoreCLI@2
            displayName: Restore NuGet Packages
            inputs:
              command: restore
              projects: '**/WebApp.csproj'

          # Replacement for WhiteSource/Mend task: basic vulnerability report via .NET CLI.
          - ${{ if parameters.runCompletePipeline }}:
              - pwsh: |
                  $proj = Get-ChildItem -Recurse -Filter WebApp.csproj | Select-Object -First 1
                  if (-not $proj) { throw 'WebApp.csproj not found.' }

                  Write-Host "Running: dotnet list package --vulnerable --include-transitive"
                  dotnet list "$($proj.FullName)" package --vulnerable --include-transitive
                displayName: Report vulnerable NuGet packages (dotnet list)

          - task: DotNetCoreCLI@2
            displayName: Build WebApp
            inputs:
              projects: '**/WebApp.csproj'
              arguments: --configuration $(BuildConfiguration)

          - task: DotNetCoreCLI@2
            displayName: Run Unit Tests
            condition: and(succeeded(), eq('${{ parameters.runCompletePipeline }}', 'true'))
            inputs:
              command: test
              projects: '**/*UnitTest*.csproj'
              arguments: --configuration $(BuildConfiguration)

          - task: DotNetCoreCLI@2
            displayName: Create WebApp.zip
            inputs:
              command: publish
              publishWebProjects: true
              arguments: --configuration $(BuildConfiguration) --output $(Build.ArtifactStagingDirectory)
              zipAfterPublish: true

          - task: PublishBuildArtifacts@1
            displayName: Publish Artifact (WebApp.zip)
            inputs:
              PathtoPublish: $(Build.ArtifactStagingDirectory)
              ArtifactName: drop

      - job: Database
        displayName: Build Database
        pool:
          vmImage: windows-2019
        steps:
          - checkout: self

          - task: MSBuild@1
            displayName: Build WebApp.Database.sqlproj
            inputs:
              solution: WebApp.Database/WebApp.Database.sqlproj
              msbuildArguments: /p:OutDir=$(Build.ArtifactStagingDirectory)

          - task: PublishBuildArtifacts@1
            displayName: Publish Artifact (Dacpac)
            inputs:
              PathtoPublish: $(Build.ArtifactStagingDirectory)
              ArtifactName: dacpac

      - job: Selenium
        displayName: Build UI Tests
        pool:
          vmImage: windows-2019
        steps:
          - checkout: self

          - task: NuGetToolInstaller@0
            displayName: Use NuGet 4.3.0

          - task: NuGetCommand@2
            displayName: Restore NuGet Packages
            inputs:
              restoreSolution: WebAppWithDatabase.sln

          - task: MSBuild@1
            displayName: Build SeleniumUiTests.csproj
            inputs:
              solution: SeleniumUiTests/SeleniumUiTests.csproj
              msbuildArguments: /p:OutDir=$(Build.ArtifactStagingDirectory)

          - task: PublishBuildArtifacts@1
            displayName: Publish Artifact (UI-Test)
            inputs:
              PathtoPublish: $(Build.ArtifactStagingDirectory)
              ArtifactName: ui-tests

      - job: Infrastructure
        displayName: Publish Infra files
        pool:
          vmImage: ubuntu-latest
        steps:
          - checkout: self

          - task: PublishBuildArtifacts@1
            displayName: Publish Artifact (ARM templates)
            inputs:
              PathtoPublish: AzureResourceGroupDeployment
              ArtifactName: arm

  - stage: Dev_Stage
    displayName: Create & Deploy to Dev
    dependsOn: Build_Stage
    jobs:
      - job: Create_DEV
        displayName: Create DEV
        pool:
          vmImage: windows-2019
        steps:
          - checkout: none

          - task: DownloadBuildArtifacts@0
            displayName: Download ARM templates
            inputs:
              artifactName: arm
              downloadPath: $(System.DefaultWorkingDirectory)

          - task: AzureResourceGroupDeployment@2
            displayName: Validate ARM templates
            inputs:
              azureSubscription: $(azureSubscription)
              action: Create Or Update Resource Group
              resourceGroupName: $(ResourceGroupName)
              location: West Europe
              templateLocation: Linked artifact
              csmFile: $(System.DefaultWorkingDirectory)/arm/WebSiteSQLDatabase.json
              csmParametersFile: $(System.DefaultWorkingDirectory)/arm/WebSiteSQLDatabase.parameters.json
              overrideParameters: >
                -hostingPlanName $(hostingPlanName)
                -skuName "F1"
                -skuCapacity 1
                -administratorLogin $(Database.Admin)
                -administratorLoginPassword $(Database.Password)
                -databaseName $(Database.Name)
                -collation "SQL_Latin1_General_CP1_CI_AS"
                -edition "Basic"
                -maxSizeBytes "1073741824"
                -requestedServiceObjectiveName "Basic"
                -webSiteName $(WebAppName)
                -sqlserverName $(SqlServerName)
              deploymentMode: Validation

          # Replacement for AzSKARMTemplateChecker + RunARMTTKTests: PSRule scan (no Marketplace tasks).
          - ${{ if and(parameters.runCompletePipeline, parameters.templateScanEnabled) }}:
              - pwsh: |
                  Set-StrictMode -Version Latest
                  $ErrorActionPreference = 'Stop'

                  Install-Module PSRule -Scope CurrentUser -Force -AllowClobber
                  Install-Module PSRule.Rules.Azure -Scope CurrentUser -Force -AllowClobber

                  $armPath = Join-Path "$(System.DefaultWorkingDirectory)" 'arm'
                  $outDir = Join-Path $armPath 'results'
                  New-Item -ItemType Directory -Force -Path $outDir | Out-Null

                  Assert-PSRule -Module PSRule.Rules.Azure -Path $armPath -Format NUnit3 -OutputPath (Join-Path $outDir 'psrule-arm.xml')
                displayName: Scan ARM templates (PSRule.Rules.Azure)

          - task: PublishTestResults@2
            displayName: Publish Template Scan Results
            condition: always()
            inputs:
              testResultsFormat: NUnit
              testResultsFiles: $(System.DefaultWorkingDirectory)/arm/results/*.xml

          - task: AzureCLI@2
            displayName: Preview Template Changes (What-If)
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: bash
              scriptLocation: inlineScript
              workingDirectory: $(System.DefaultWorkingDirectory)/arm/
              inlineScript: |
                az deployment group what-if \
                  --resource-group "$(ResourceGroupName)" \
                  --name rollout01 \
                  --template-file WebSiteSQLDatabase.json \
                  --parameters WebSiteSQLDatabase.parameters.json \
                  --parameters hostingPlanName=$(hostingPlanName) \
                              skuName=F1 \
                              skuCapacity=1 \
                              administratorLogin=$(Database.Admin) \
                              administratorLoginPassword=$(Database.Password) \
                              databaseName=$(Database.Name) \
                              collation=SQL_Latin1_General_CP1_CI_AS \
                              edition=Basic \
                              maxSizeBytes=1073741824 \
                              requestedServiceObjectiveName=Basic \
                              webSiteName=$(WebAppName) \
                              sqlserverName=$(SqlServerName)

          - task: AzureResourceManagerTemplateDeployment@3
            displayName: Deploy ARM templates
            inputs:
              deploymentScope: Resource Group
              azureResourceManagerConnection: $(azureSubscription)
              action: Create Or Update Resource Group
              resourceGroupName: $(ResourceGroupName)
              location: West Europe
              templateLocation: Linked artifact
              csmFile: $(System.DefaultWorkingDirectory)/arm/WebSiteSQLDatabase.json
              csmParametersFile: $(System.DefaultWorkingDirectory)/arm/WebSiteSQLDatabase.parameters.json
              overrideParameters: >
                -hostingPlanName $(hostingPlanName)
                -skuName "F1"
                -skuCapacity 1
                -administratorLogin $(Database.Admin)
                -administratorLoginPassword $(Database.Password)
                -databaseName $(Database.Name)
                -collation "SQL_Latin1_General_CP1_CI_AS"
                -edition "Basic"
                -maxSizeBytes "1073741824"
                -requestedServiceObjectiveName "Basic"
                -webSiteName $(WebAppName)
                -sqlserverName $(SqlServerName)
              deploymentMode: Complete

      - job: Deploy_DEV
        displayName: Deploy Apps to DEV
        dependsOn: Create_DEV
        pool:
          vmImage: windows-2019
        steps:
          - checkout: none

          - task: DownloadBuildArtifacts@0
            displayName: Download WebApp.zip
            inputs:
              buildType: current
              downloadType: single
              artifactName: drop
              itemPattern: '**/WebApp.zip'
              downloadPath: $(System.DefaultWorkingDirectory)

          - task: AzureRmWebAppDeployment@3
            displayName: Deploy WebApp to Azure
            inputs:
              azureSubscription: $(azureSubscription)
              appType: app
              WebAppName: $(WebAppName)
              Package: $(System.DefaultWorkingDirectory)/drop/WebApp.zip
              TakeAppOfflineFlag: true
              JSONFiles: '**/appsettings.json'

          - task: DownloadBuildArtifacts@0
            displayName: Download DacPac
            inputs:
              buildType: current
              downloadType: single
              artifactName: dacpac
              itemPattern: '**/*.dacpac'
              downloadPath: $(System.DefaultWorkingDirectory)

          - task: SqlAzureDacpacDeployment@1
            displayName: Deploy DacPac to SQL Azure
            inputs:
              azureSubscription: $(azureSubscription)
              AuthenticationType: server
              ServerName: $(SqlServerName).database.windows.net,1433
              DatabaseName: $(Database.Name)
              SqlUsername: $(Database.Admin)
              SqlPassword: $(Database.Password)
              deployType: DacpacTask
              DeploymentAction: Publish
              DacpacFile: $(System.DefaultWorkingDirectory)/dacpac/WebApp.Database.dacpac
              IpDetectionMethod: AutoDetect

      - job: Test_DEV
        displayName: Run Selenium tests in DEV
        dependsOn: Deploy_DEV
        pool:
          vmImage: windows-2019
        steps:
          - checkout: none

          - task: DownloadBuildArtifacts@0
            displayName: Download Selenium Tests
            inputs:
              buildType: current
              downloadType: single
              artifactName: ui-tests
              downloadPath: $(System.DefaultWorkingDirectory)

          - task: VSTest@2
            displayName: Run Selenium UI Tests
            inputs:
              testSelector: testAssemblies
              searchFolder: $(System.DefaultWorkingDirectory)/ui-tests
              runSettingsFile: $(System.DefaultWorkingDirectory)/ui-tests/.runsettings
              overrideTestrunParameters: -webAppUrl $(WebAppNameUrl)
              testAssemblyVer2: |
                **\*Test*.dll
                !**\*TestAdapter.dll
                !**\obj\**
              runInParallel: false
              codeCoverageEnabled: true

  - stage: Test_Stage
    displayName: Test Stage
    jobs:
      - job: Deploy_Test
        displayName: Deploy to Test
        pool:
          vmImage: ubuntu-latest
        steps:
          - script: ls
            displayName: List files

  - stage: Prod_Stage
    displayName: Prod Stage
    jobs:
      - job: Deploy_Prod
        displayName: Deploy to Prod
        pool:
          vmImage: ubuntu-latest
        steps:
          - script: ls
            displayName: List files
