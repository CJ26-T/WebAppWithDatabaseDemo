pr:
  branches:
    include:
      - dev
  paths:
    exclude:
      - docs/*
      - README.md

trigger:
  branches:
    include:
      - master
  paths:
    exclude:
      - docs/*
      - README.md
      - 01_azure-pipelines-ci.yml
      - 02_azure-pipelines-ci.yml
      - 03_azure-pipelines-ci-cd.yml

parameters:
  - name: runCompletePipeline
    displayName: Run optional scans? (no Marketplace tasks)
    type: boolean
    default: false

  - name: templateScanEnabled
    displayName: Scan ARM templates via PSRule (no extensions)
    type: boolean
    default: false

variables:
  BuildConfiguration: release
  azureSubscription: WebAppWithDatabaseDemo_spn

  # ✅ 你想用的 region（先填一個常見的代碼）
  # 你可以改成：eastasia / southeastasia / japaneast / australiasoutheast / northeurope ...
  Location: eastus

  Prefix: tunis
  EnvironmentName: dev
  UniqueId: '1280'

  ResourceGroupName: $(Prefix)-$(EnvironmentName)-$(UniqueId)-RG
  WebAppName: $(Prefix)-$(EnvironmentName)-$(UniqueId)
  WebAppNameUrl: https://$(WebAppName).azurewebsites.net/
  SqlServerName: $(Prefix)-sql-$(EnvironmentName)-$(UniqueId)
  hostingPlanName: $(Prefix)-service-plan

  Database.Admin: houssem
  Database.Password: '@Aa123456'
  Database.Name: EmployeesDB

stages:
  - stage: Build_Stage
    displayName: Build Apps
    jobs:
      - job: WebApp
        displayName: Build Web App
        pool:
          vmImage: windows-2022
        steps:
          - checkout: self
          - task: UseDotNet@2
            displayName: Install .NET 6 SDK
            inputs:
              packageType: sdk
              version: 6.0.x

          - task: DotNetCoreCLI@2
            displayName: Restore NuGet Packages
            inputs:
              command: restore
              projects: '**/WebApp.csproj'

          - ${{ if parameters.runCompletePipeline }}:
              - pwsh: |
                  $proj = Get-ChildItem -Recurse -Filter WebApp.csproj | Select-Object -First 1
                  if (-not $proj) { throw 'WebApp.csproj not found.' }
                  dotnet list "$($proj.FullName)" package --vulnerable --include-transitive
                displayName: Report vulnerable NuGet packages (dotnet list)

          - task: DotNetCoreCLI@2
            displayName: Build WebApp
            inputs:
              projects: '**/WebApp.csproj'
              arguments: --configuration $(BuildConfiguration)

          - ${{ if parameters.runCompletePipeline }}:
              - task: DotNetCoreCLI@2
                displayName: Run Unit Tests
                inputs:
                  command: test
                  projects: '**/*UnitTest*.csproj'
                  arguments: --configuration $(BuildConfiguration)

          - task: DotNetCoreCLI@2
            displayName: Create WebApp.zip
            inputs:
              command: publish
              publishWebProjects: true
              arguments: --configuration $(BuildConfiguration) --output $(Build.ArtifactStagingDirectory)
              zipAfterPublish: true

          - task: PublishPipelineArtifact@1
            displayName: Publish Artifact (WebApp.zip)
            inputs:
              targetPath: $(Build.ArtifactStagingDirectory)
              artifact: drop

      - job: Database
        displayName: Build Database
        pool:
          vmImage: windows-2022
        steps:
          - checkout: self

          - task: NuGetToolInstaller@1
            displayName: Install NuGet (for net45 reference assemblies)

          - pwsh: |
              Set-StrictMode -Version Latest
              $ErrorActionPreference = 'Stop'

              $outRoot = Join-Path "$(Agent.TempDirectory)" 'refasms'
              New-Item -ItemType Directory -Force -Path $outRoot | Out-Null

              nuget install Microsoft.NETFramework.ReferenceAssemblies.net45 -OutputDirectory $outRoot -ExcludeVersion

              $net45Path = Join-Path $outRoot 'Microsoft.NETFramework.ReferenceAssemblies.net45\build\.NETFramework\v4.5'
              if (-not (Test-Path $net45Path)) { throw "Expected net45 reference assemblies at: $net45Path" }

              Write-Host "##vso[task.setvariable variable=FrameworkPathOverride]$net45Path"
            displayName: Provide .NET Framework 4.5 reference assemblies

          - task: MSBuild@1
            displayName: Build WebApp.Database.sqlproj
            inputs:
              solution: WebApp.Database/WebApp.Database.sqlproj
              msbuildArguments: /p:OutDir=$(Build.ArtifactStagingDirectory) /p:FrameworkPathOverride=$(FrameworkPathOverride)

          - task: PublishPipelineArtifact@1
            displayName: Publish Artifact (Dacpac)
            inputs:
              targetPath: $(Build.ArtifactStagingDirectory)
              artifact: dacpac

      - job: Selenium
        displayName: Build UI Tests
        pool:
          vmImage: windows-2022
        steps:
          - checkout: self

          - task: NuGetToolInstaller@1
            displayName: Use NuGet 4.3.0

          - task: NuGetCommand@2
            displayName: Restore NuGet Packages
            inputs:
              restoreSolution: WebAppWithDatabase.sln

          - task: MSBuild@1
            displayName: Build SeleniumUiTests.csproj
            inputs:
              solution: SeleniumUiTests/SeleniumUiTests.csproj
              msbuildArguments: /p:OutDir=$(Build.ArtifactStagingDirectory)

          - task: PublishPipelineArtifact@1
            displayName: Publish Artifact (UI-Test)
            inputs:
              targetPath: $(Build.ArtifactStagingDirectory)
              artifact: ui-tests

      - job: Infrastructure
        displayName: Publish Infra files
        pool:
          vmImage: ubuntu-22.04
        steps:
          - checkout: self
          - task: PublishPipelineArtifact@1
            displayName: Publish Artifact (ARM templates)
            inputs:
              targetPath: AzureResourceGroupDeployment
              artifact: arm

  - stage: Dev_Stage
    displayName: Create & Deploy to Dev
    dependsOn: Build_Stage
    jobs:
      - job: Create_DEV
        displayName: Create DEV
        pool:
          vmImage: windows-2022
        steps:
          - checkout: none

          - task: DownloadPipelineArtifact@2
            displayName: Download ARM templates
            inputs:
              artifact: arm
              path: $(System.DefaultWorkingDirectory)

          # ✅ NEW：挑選「訂閱允許」的 region，並建立 RG（同時把最後採用的 region 印出來）
          - task: AzureCLI@2
            displayName: Pick eligible region + create RG
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -e

                echo "== Subscription =="
                az account show --query "{name:name, id:id, tenantId:tenantId}" -o json

                echo "== Allowed locations (top 30) =="
                az account list-locations --query "[0:30].{name:name, displayName:displayName}" -o table

                TARGET="$(Location)"
                echo "Requested location: $TARGET"

                OK=$(az account list-locations --query "[?name=='$TARGET'] | length(@)" -o tsv)
                if [ "$OK" != "1" ]; then
                  echo "##vso[task.logissue type=warning]Location '$TARGET' not allowed. Falling back to 'southeastasia'."
                  TARGET="southeastasia"
                  OK2=$(az account list-locations --query "[?name=='$TARGET'] | length(@)" -o tsv)
                  if [ "$OK2" != "1" ]; then
                    echo "##vso[task.logissue type=warning]Fallback 'southeastasia' not allowed. Falling back to 'eastus'."
                    TARGET="eastus"
                  fi
                fi

                echo "Using location: $TARGET"
                echo "##vso[task.setvariable variable=Location]$TARGET"

                az group create -n "$(ResourceGroupName)" -l "$TARGET" -o table

          - task: AzureResourceGroupDeployment@2
            displayName: Validate ARM templates
            inputs:
              azureSubscription: $(azureSubscription)
              action: Create Or Update Resource Group
              resourceGroupName: $(ResourceGroupName)
              location: $(Location)
              templateLocation: Linked artifact
              csmFile: $(System.DefaultWorkingDirectory)/WebSiteSQLDatabase.json
              csmParametersFile: $(System.DefaultWorkingDirectory)/WebSiteSQLDatabase.parameters.json
              overrideParameters: >
                -hostingPlanName $(hostingPlanName)
                -skuName "F1"
                -skuCapacity 1
                -administratorLogin $(Database.Admin)
                -administratorLoginPassword $(Database.Password)
                -databaseName $(Database.Name)
                -collation "SQL_Latin1_General_CP1_CI_AS"
                -edition "Basic"
                -maxSizeBytes "1073741824"
                -requestedServiceObjectiveName "Basic"
                -webSiteName $(WebAppName)
                -sqlserverName $(SqlServerName)
              deploymentMode: Validation

          - ${{ if and(parameters.runCompletePipeline, parameters.templateScanEnabled) }}:
              - pwsh: |
                  Set-StrictMode -Version Latest
                  $ErrorActionPreference = 'Stop'
                  Install-Module PSRule -Scope CurrentUser -Force -AllowClobber
                  Install-Module PSRule.Rules.Azure -Scope CurrentUser -Force -AllowClobber

                  $armPath = "$(System.DefaultWorkingDirectory)"
                  $outDir = Join-Path $armPath 'results'
                  New-Item -ItemType Directory -Force -Path $outDir | Out-Null

                  Assert-PSRule -Module PSRule.Rules.Azure -Path $armPath -Format NUnit3 -OutputPath (Join-Path $outDir 'psrule-arm.xml')
                displayName: Scan ARM templates (PSRule.Rules.Azure)

          - task: PublishTestResults@2
            displayName: Publish Template Scan Results
            condition: always()
            inputs:
              testResultsFormat: NUnit
              testResultsFiles: $(System.DefaultWorkingDirectory)/results/*.xml

          - task: AzureCLI@2
            displayName: Preview Template Changes (What-If)
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: bash
              scriptLocation: inlineScript
              workingDirectory: $(System.DefaultWorkingDirectory)
              inlineScript: |
                set -e
                echo "Using location: $(Location)"
                az deployment group what-if \
                  --resource-group "$(ResourceGroupName)" \
                  --name rollout01 \
                  --template-file WebSiteSQLDatabase.json \
                  --parameters WebSiteSQLDatabase.parameters.json \
                  --parameters hostingPlanName=$(hostingPlanName) \
                              skuName=F1 \
                              skuCapacity=1 \
                              administratorLogin=$(Database.Admin) \
                              administratorLoginPassword=$(Database.Password) \
                              databaseName=$(Database.Name) \
                              collation=SQL_Latin1_General_CP1_CI_AS \
                              edition=Basic \
                              maxSizeBytes=1073741824 \
                              requestedServiceObjectiveName=Basic \
                              webSiteName=$(WebAppName) \
                              sqlserverName=$(SqlServerName)

          - task: AzureResourceManagerTemplateDeployment@3
            displayName: Deploy ARM templates
            inputs:
              deploymentScope: Resource Group
              azureResourceManagerConnection: $(azureSubscription)
              action: Create Or Update Resource Group
              resourceGroupName: $(ResourceGroupName)
              location: $(Location)
              templateLocation: Linked artifact
              csmFile: $(System.DefaultWorkingDirectory)/WebSiteSQLDatabase.json
              csmParametersFile: $(System.DefaultWorkingDirectory)/WebSiteSQLDatabase.parameters.json
              overrideParameters: >
                -hostingPlanName $(hostingPlanName)
                -skuName "F1"
                -skuCapacity 1
                -administratorLogin $(Database.Admin)
                -administratorLoginPassword $(Database.Password)
                -databaseName $(Database.Name)
                -collation "SQL_Latin1_General_CP1_CI_AS"
                -edition "Basic"
                -maxSizeBytes "1073741824"
                -requestedServiceObjectiveName "Basic"
                -webSiteName $(WebAppName)
                -sqlserverName $(SqlServerName)
              deploymentMode: Complete

      - job: Deploy_DEV
        displayName: Deploy Apps to DEV
        dependsOn: Create_DEV
        pool:
          vmImage: windows-2022
        steps:
          - checkout: none

          - task: DownloadPipelineArtifact@2
            displayName: Download WebApp.zip
            inputs:
              artifact: drop
              path: $(System.DefaultWorkingDirectory)

          - task: AzureRmWebAppDeployment@3
            displayName: Deploy WebApp to Azure
            inputs:
              azureSubscription: $(azureSubscription)
              appType: app
              WebAppName: $(WebAppName)
              Package: $(System.DefaultWorkingDirectory)/drop/WebApp.zip
              TakeAppOfflineFlag: true
              JSONFiles: '**/appsettings.json'

          - task: DownloadPipelineArtifact@2
            displayName: Download DacPac
            inputs:
              artifact: dacpac
              path: $(System.DefaultWorkingDirectory)

          - task: SqlAzureDacpacDeployment@1
            displayName: Deploy DacPac to SQL Azure
            inputs:
              azureSubscription: $(azureSubscription)
              AuthenticationType: server
              ServerName: $(SqlServerName).database.windows.net,1433
              DatabaseName: $(Database.Name)
              SqlUsername: $(Database.Admin)
              SqlPassword: $(Database.Password)
              deployType: DacpacTask
              DeploymentAction: Publish
              DacpacFile: $(System.DefaultWorkingDirectory)/dacpac/WebApp.Database.dacpac
              IpDetectionMethod: AutoDetect

      - job: Test_DEV
        displayName: Run Selenium tests in DEV
        dependsOn: Deploy_DEV
        pool:
          vmImage: windows-2022
        steps:
          - checkout: none

          - task: DownloadPipelineArtifact@2
            displayName: Download Selenium Tests
            inputs:
              artifact: ui-tests
              path: $(System.DefaultWorkingDirectory)

          - task: VSTest@2
            displayName: Run Selenium UI Tests
            inputs:
              testSelector: testAssemblies
              searchFolder: $(System.DefaultWorkingDirectory)/ui-tests
              runSettingsFile: $(System.DefaultWorkingDirectory)/ui-tests/.runsettings
              overrideTestrunParameters: -webAppUrl $(WebAppNameUrl)
              testAssemblyVer2: |
                **\*Test*.dll
                !**\*TestAdapter.dll
                !**\obj\**
              runInParallel: false
              codeCoverageEnabled: true

  - stage: Test_Stage
    displayName: Test Stage
    jobs:
      - job: Deploy_Test
        displayName: Deploy to Test
        pool:
          vmImage: ubuntu-22.04
        steps:
          - script: ls
            displayName: List files

  - stage: Prod_Stage
    displayName: Prod Stage
    jobs:
      - job: Deploy_Prod
        displayName: Deploy to Prod
        pool:
          vmImage: ubuntu-22.04
        steps:
          - script: ls
            displayName: List files
