pr:
  branches:
    include:
      - dev
  paths:
    exclude:
      - docs/*
      - README.md

trigger:
  branches:
    include:
      - master
  paths:
    exclude:
      - docs/*
      - README.md
      - 01_azure-pipelines-ci.yml
      - 02_azure-pipelines-ci.yml
      - 03_azure-pipelines-ci-cd.yml

parameters:
  - name: runCompletePipeline
    displayName: Run optional scans? (no Marketplace tasks)
    type: boolean
    default: false

  - name: templateScanEnabled
    displayName: Scan ARM templates via PSRule (no extensions)
    type: boolean
    default: false

variables:
  BuildConfiguration: release

  # Azure DevOps service connection name
  azureSubscription: WebAppWithDatabaseDemo_spn

  # ✅ 固定用一個你訂閱允許的 region（可改：southeastasia / japaneast / eastasia / northeurope / australiaeast ...）
  # ⚠️ 你之前遇到 westeurope ineligible，所以不要再用 westeurope
  Location: southeastasia

  Prefix: tunis
  EnvironmentName: dev

  # ✅ 每次跑都不同，避免撞名/撞 RG location
  UniqueId: $(Build.BuildId)

  # ✅ RG 名稱包含 Location，避免你之前「RG 已存在在 westeurope」導致無法換 location
  ResourceGroupName: $(Prefix)-$(EnvironmentName)-$(UniqueId)-$(Location)-RG

  WebAppName: $(Prefix)-$(EnvironmentName)-$(UniqueId)
  WebAppNameUrl: https://$(WebAppName).azurewebsites.net/
  SqlServerName: $(Prefix)-sql-$(EnvironmentName)-$(UniqueId)
  hostingPlanName: $(Prefix)-service-plan

  Database.Admin: houssem
  Database.Password: '@Aa123456' # ⚠️ 請改成 secret variable / variable group
  Database.Name: EmployeesDB

stages:
  - stage: Build_Stage
    displayName: Build Apps
    jobs:
      - job: WebApp
        displayName: Build Web App
        pool:
          vmImage: windows-2022
        steps:
          - checkout: self

          - task: UseDotNet@2
            displayName: Install .NET 6 SDK
            inputs:
              packageType: sdk
              version: 6.0.x

          - task: DotNetCoreCLI@2
            displayName: Restore NuGet Packages
            inputs:
              command: restore
              projects: '**/WebApp.csproj'

          - ${{ if parameters.runCompletePipeline }}:
              - pwsh: |
                  $proj = Get-ChildItem -Recurse -Filter WebApp.csproj | Select-Object -First 1
                  if (-not $proj) { throw 'WebApp.csproj not found.' }
                  dotnet list "$($proj.FullName)" package --vulnerable --include-transitive
                displayName: Report vulnerable NuGet packages (dotnet list)

          - task: DotNetCoreCLI@2
            displayName: Build WebApp
            inputs:
              projects: '**/WebApp.csproj'
              arguments: --configuration $(BuildConfiguration)

          - ${{ if parameters.runCompletePipeline }}:
              - task: DotNetCoreCLI@2
                displayName: Run Unit Tests
                inputs:
                  command: test
                  projects: '**/*UnitTest*.csproj'
                  arguments: --configuration $(BuildConfiguration)

          - task: DotNetCoreCLI@2
            displayName: Create WebApp.zip
            inputs:
              command: publish
              publishWebProjects: true
              arguments: --configuration $(BuildConfiguration) --output $(Build.ArtifactStagingDirectory)
              zipAfterPublish: true

          - task: PublishPipelineArtifact@1
            displayName: Publish Artifact (WebApp.zip)
            inputs:
              targetPath: $(Build.ArtifactStagingDirectory)
              artifact: drop

      - job: Database
        displayName: Build Database
        pool:
          vmImage: windows-2022
        steps:
          - checkout: self

          - task: NuGetToolInstaller@1
            displayName: Install NuGet (for net45 reference assemblies)

          - pwsh: |
              Set-StrictMode -Version Latest
              $ErrorActionPreference = 'Stop'

              $outRoot = Join-Path "$(Agent.TempDirectory)" 'refasms'
              New-Item -ItemType Directory -Force -Path $outRoot | Out-Null

              nuget install Microsoft.NETFramework.ReferenceAssemblies.net45 -OutputDirectory $outRoot -ExcludeVersion

              $net45Path = Join-Path $outRoot 'Microsoft.NETFramework.ReferenceAssemblies.net45\build\.NETFramework\v4.5'
              if (-not (Test-Path $net45Path)) { throw "Expected net45 reference assemblies at: $net45Path" }

              Write-Host "##vso[task.setvariable variable=FrameworkPathOverride]$net45Path"
            displayName: Provide .NET Framework 4.5 reference assemblies

          - task: MSBuild@1
            displayName: Build WebApp.Database.sqlproj
            inputs:
              solution: WebApp.Database/WebApp.Database.sqlproj
              msbuildArguments: /p:OutDir=$(Build.ArtifactStagingDirectory) /p:FrameworkPathOverride=$(FrameworkPathOverride)

          - task: PublishPipelineArtifact@1
            displayName: Publish Artifact (Dacpac)
            inputs:
              targetPath: $(Build.ArtifactStagingDirectory)
              artifact: dacpac

      - job: Selenium
        displayName: Build UI Tests
        pool:
          vmImage: windows-2022
        steps:
          - checkout: self

          - task: NuGetToolInstaller@1
            displayName: Use NuGet 4.3.0

          - task: NuGetCommand@2
            displayName: Restore NuGet Packages
            inputs:
              restoreSolution: WebAppWithDatabase.sln

          - task: MSBuild@1
            displayName: Build SeleniumUiTests.csproj
            inputs:
              solution: SeleniumUiTests/SeleniumUiTests.csproj
              msbuildArguments: /p:OutDir=$(Build.ArtifactStagingDirectory)

          - task: PublishPipelineArtifact@1
            displayName: Publish Artifact (UI-Test)
            inputs:
              targetPath: $(Build.ArtifactStagingDirectory)
              artifact: ui-tests

      - job: Infrastructure
        displayName: Publish Infra files (PaaS-only ARM)
        pool:
          vmImage: ubuntu-22.04
        steps:
          - checkout: self

          # ✅ 關鍵：只打包「PaaS-only 的兩個 ARM 檔」，避免 deployproj/ps1/DSC 被一起帶進去
          - bash: |
              set -e
              mkdir -p "$(Build.ArtifactStagingDirectory)/arm"

              # 這裡假設你的 ARM 檔在 repo root；如果你是放在 AzureResourceGroupDeployment/，把路徑改掉即可
              cp "WebSiteSQLDatabase.json" "$(Build.ArtifactStagingDirectory)/arm/WebSiteSQLDatabase.json"
              cp "WebSiteSQLDatabase.parameters.json" "$(Build.ArtifactStagingDirectory)/arm/WebSiteSQLDatabase.parameters.json"

              echo "== ARM packaged files =="
              ls -al "$(Build.ArtifactStagingDirectory)/arm"
            displayName: Stage PaaS-only ARM files

          - task: PublishPipelineArtifact@1
            displayName: Publish Artifact (ARM templates - PaaS only)
            inputs:
              targetPath: $(Build.ArtifactStagingDirectory)/arm
              artifact: arm

  - stage: Dev_Stage
    displayName: Create & Deploy to Dev
    dependsOn: Build_Stage
    jobs:
      - job: Create_DEV
        displayName: Create DEV (PaaS-only)
        pool:
          vmImage: windows-2022
        steps:
          - checkout: none

          - task: DownloadPipelineArtifact@2
            displayName: Download ARM templates (PaaS only)
            inputs:
              artifact: arm
              path: $(Pipeline.Workspace)/arm

          # ✅ 關鍵：部署前硬檢查不能有 Microsoft.Compute（避免 Free VM quota 直接炸）
          - pwsh: |
              $template = "$(Pipeline.Workspace)\arm\WebSiteSQLDatabase.json"
              $params   = "$(Pipeline.Workspace)\arm\WebSiteSQLDatabase.parameters.json"

              if (!(Test-Path $template)) { throw "Missing template: $template" }
              if (!(Test-Path $params))   { throw "Missing params:   $params" }

              $c = Get-Content $template -Raw
              if ($c -match "Microsoft\.Compute") {
                throw "Template contains Microsoft.Compute (VM). Your subscription Free VM quota=0 -> will fail."
              }

              Write-Host "OK: Using PaaS-only ARM:"
              Write-Host " - $template"
              Write-Host " - $params"
            displayName: Guardrail - fail if template contains VM

          # 建 RG（用 Location 變數）
          - task: AzureCLI@2
            displayName: Create RG
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -e
                echo "Using location: $(Location)"
                az group create -n "$(ResourceGroupName)" -l "$(Location)" -o table

          # validate（用 az，完全不走 deployment project / ps1）
          - task: AzureCLI@2
            displayName: ARM validate (az deployment group validate)
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -e
                cd "$(Pipeline.Workspace)/arm"

                az deployment group validate \
                  --resource-group "$(ResourceGroupName)" \
                  --template-file WebSiteSQLDatabase.json \
                  --parameters WebSiteSQLDatabase.parameters.json \
                  --parameters hostingPlanName=$(hostingPlanName) \
                              skuName=F1 \
                              skuCapacity=1 \
                              administratorLogin=$(Database.Admin) \
                              administratorLoginPassword=$(Database.Password) \
                              databaseName=$(Database.Name) \
                              collation=SQL_Latin1_General_CP1_CI_AS \
                              edition=Basic \
                              maxSizeBytes=1073741824 \
                              requestedServiceObjectiveName=Basic \
                              webSiteName=$(WebAppName) \
                              sqlserverName=$(SqlServerName) \
                  -o jsonc

          # what-if（可選，但建議保留）
          - task: AzureCLI@2
            displayName: ARM what-if (az deployment group what-if)
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -e
                cd "$(Pipeline.Workspace)/arm"

                az deployment group what-if \
                  --resource-group "$(ResourceGroupName)" \
                  --name rollout01 \
                  --template-file WebSiteSQLDatabase.json \
                  --parameters WebSiteSQLDatabase.parameters.json \
                  --parameters hostingPlanName=$(hostingPlanName) \
                              skuName=F1 \
                              skuCapacity=1 \
                              administratorLogin=$(Database.Admin) \
                              administratorLoginPassword=$(Database.Password) \
                              databaseName=$(Database.Name) \
                              collation=SQL_Latin1_General_CP1_CI_AS \
                              edition=Basic \
                              maxSizeBytes=1073741824 \
                              requestedServiceObjectiveName=Basic \
                              webSiteName=$(WebAppName) \
                              sqlserverName=$(SqlServerName)

          # deploy（用 az create）
          - task: AzureCLI@2
            displayName: ARM deploy (az deployment group create)
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -e
                cd "$(Pipeline.Workspace)/arm"

                az deployment group create \
                  --resource-group "$(ResourceGroupName)" \
                  --name WebSiteSQLDatabase \
                  --template-file WebSiteSQLDatabase.json \
                  --parameters WebSiteSQLDatabase.parameters.json \
                  --parameters hostingPlanName=$(hostingPlanName) \
                              skuName=F1 \
                              skuCapacity=1 \
                              administratorLogin=$(Database.Admin) \
                              administratorLoginPassword=$(Database.Password) \
                              databaseName=$(Database.Name) \
                              collation=SQL_Latin1_General_CP1_CI_AS \
                              edition=Basic \
                              maxSizeBytes=1073741824 \
                              requestedServiceObjectiveName=Basic \
                              webSiteName=$(WebAppName) \
                              sqlserverName=$(SqlServerName) \
                  -o jsonc

      - job: Deploy_DEV
        displayName: Deploy Apps to DEV
        dependsOn: Create_DEV
        pool:
          vmImage: windows-2022
        steps:
          - checkout: none

          - task: DownloadPipelineArtifact@2
            displayName: Download WebApp.zip
            inputs:
              artifact: drop
              path: $(Pipeline.Workspace)/drop

          - task: AzureRmWebAppDeployment@3
            displayName: Deploy WebApp to Azure
            inputs:
              azureSubscription: $(azureSubscription)
              appType: app
              WebAppName: $(WebAppName)
              Package: $(Pipeline.Workspace)/drop/WebApp.zip
              TakeAppOfflineFlag: true
              JSONFiles: '**/appsettings.json'

          - task: DownloadPipelineArtifact@2
            displayName: Download DacPac
            inputs:
              artifact: dacpac
              path: $(Pipeline.Workspace)/dacpac

          - task: SqlAzureDacpacDeployment@1
            displayName: Deploy DacPac to SQL Azure
            inputs:
              azureSubscription: $(azureSubscription)
              AuthenticationType: server
              ServerName: $(SqlServerName).database.windows.net,1433
              DatabaseName: $(Database.Name)
              SqlUsername: $(Database.Admin)
              SqlPassword: $(Database.Password)
              deployType: DacpacTask
              DeploymentAction: Publish
              DacpacFile: $(Pipeline.Workspace)/dacpac/WebApp.Database.dacpac
              IpDetectionMethod: AutoDetect

      - job: Test_DEV
        displayName: Run Selenium tests in DEV
        dependsOn: Deploy_DEV
        pool:
          vmImage: windows-2022
        steps:
          - checkout: none

          - task: DownloadPipelineArtifact@2
            displayName: Download Selenium Tests
            inputs:
              artifact: ui-tests
              path: $(Pipeline.Workspace)/ui-tests

          - task: VSTest@2
            displayName: Run Selenium UI Tests
            inputs:
              testSelector: testAssemblies
              searchFolder: $(Pipeline.Workspace)/ui-tests
              runSettingsFile: $(Pipeline.Workspace)/ui-tests/.runsettings
              overrideTestrunParameters: -webAppUrl $(WebAppNameUrl)
              testAssemblyVer2: |
                **\*Test*.dll
                !**\*TestAdapter.dll
                !**\obj\**
              runInParallel: false
              codeCoverageEnabled: true

  - stage: Test_Stage
    displayName: Test Stage
    jobs:
      - job: Deploy_Test
        displayName: Deploy to Test
        pool:
          vmImage: ubuntu-22.04
        steps:
          - script: ls
            displayName: List files

  - stage: Prod_Stage
    displayName: Prod Stage
    jobs:
      - job: Deploy_Prod
        displayName: Deploy to Prod
        pool:
          vmImage: ubuntu-22.04
        steps:
          - script: ls
            displayName: List files
