trigger: none
pr: none

jobs:
# ============================================================
# Job 1 : WebApp
# ============================================================
- job: WebApp
  displayName: 'Build Web App'
  pool:
    vmImage: 'windows-latest'

  variables:
    BuildConfiguration: release

  steps:
  - task: UseDotNet@2
    displayName: Install .NET 6 sdk
    inputs:
      packageType: sdk
      version: 6.0.x
      installationPath: $(Agent.ToolsDirectory)/dotnet

  - task: DotNetCoreCLI@2
    displayName: Restore
    inputs:
      command: restore
      projects: '**/WebApp.csproj'

  - task: DotNetCoreCLI@2
    displayName: Build
    inputs:
      projects: '**/WebApp.csproj'
      arguments: '--configuration $(BuildConfiguration)'

  - task: DotNetCoreCLI@2
    displayName: Test
    inputs:
      command: test
      projects: '**/*UnitTest*.csproj'
      arguments: '--configuration $(BuildConfiguration)'

  - task: DotNetCoreCLI@2
    displayName: Publish
    inputs:
      command: publish
      publishWebProjects: True
      arguments: '--configuration $(BuildConfiguration) --output $(build.artifactstagingdirectory)'
      zipAfterPublish: True

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact (WebApp.zip)'
    inputs:
      PathtoPublish: '$(build.artifactstagingdirectory)'


# ============================================================
# Job 2 : Database (FIXED HARD)
# ============================================================
- job: Database
  displayName: 'Build Database'
  pool:
    vmImage: 'windows-latest'

  steps:
  # ✅ HARD FIX: Patch .sqlproj targeting framework (replace any 4.5 / v4.5 / v4.5.x to v4.8)
  - powershell: |
      $proj = "$(Build.SourcesDirectory)\WebApp.Database\WebApp.Database.sqlproj"
      Write-Host "Patching sqlproj file: $proj"

      if (!(Test-Path $proj)) {
        Write-Error "sqlproj not found: $proj"
        exit 1
      }

      $content = Get-Content -Raw -Encoding UTF8 $proj

      Write-Host "---- Before (lines containing 4.5 / TargetFramework / SqlClr) ----"
      ($content -split "`r?`n") |
        Where-Object { $_ -match "4\.5" -or $_ -match "TargetFramework" -or $_ -match "SqlClr" } |
        Select-Object -First 80 |
        ForEach-Object { Write-Host $_ }

      # Replace common patterns:
      # v4.5 / 4.5 / v4.5.1 / v4.5.2 -> v4.8
      $new = $content
      $new = [regex]::Replace($new, "v4\.5(\.\d)?", "v4.8")
      $new = [regex]::Replace($new, "(?<=>)4\.5(\.\d)?(?=<)", "4.8")

      if ($new -ne $content) {
        Set-Content -Path $proj -Value $new -Encoding UTF8
        Write-Host "✅ Patched sqlproj framework references to v4.8"
      }
      else {
        Write-Host "⚠️ No 4.5 patterns matched in sqlproj. (It might still be set elsewhere, but we'll try build.)"
      }

      $after = Get-Content -Raw -Encoding UTF8 $proj
      Write-Host "---- After (lines containing 4.8 / TargetFramework / SqlClr) ----"
      ($after -split "`r?`n") |
        Where-Object { $_ -match "4\.8" -or $_ -match "TargetFramework" -or $_ -match "SqlClr" } |
        Select-Object -First 80 |
        ForEach-Object { Write-Host $_ }
    displayName: 'HARD FIX: Patch sqlproj to .NET Framework v4.8'

  - task: MSBuild@1
    displayName: 'Build WebApp.Database.sqlproj'
    inputs:
      solution: WebApp.Database/WebApp.Database.sqlproj
      msbuildArguments: '/p:OutDir=$(Build.ArtifactStagingDirectory)'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact (Dacpac)'
    inputs:
      ArtifactName: dacpac


# ============================================================
# Job 3 : Selenium UI Tests
# ============================================================
- job: Selenium
  displayName: 'Build UI Tests'
  pool:
    vmImage: 'windows-latest'

  steps:
  - task: NuGetToolInstaller@1
    displayName: 'Use NuGet'

  - task: NuGetCommand@2
    displayName: 'NuGet restore'
    inputs:
      restoreSolution: WebAppWithDatabase.sln

  - task: MSBuild@1
    displayName: 'Build SeleniumUiTests.csproj'
    inputs:
      solution: SeleniumUiTests/SeleniumUiTests.csproj
      msbuildArguments: '/p:OutDir=$(Build.ArtifactStagingDirectory)'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact: UI-Test'
    inputs:
      ArtifactName: 'UI-Test'


# ============================================================
# Job 4 : Infrastructure
# ============================================================
- job: Infrastructure
  displayName: 'Copy Infrastructure files (ARM)'
  pool:
    vmImage: 'ubuntu-latest'

  steps:
  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact: ARM templates'
    inputs:
      PathtoPublish: AzureResourceGroupDeployment
      ArtifactName: arm
