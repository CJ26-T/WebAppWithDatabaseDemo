trigger: none
pr: none

# ============================================================
# 全域變數（部署會用到）
# ============================================================
variables:
  AzureServiceConnection: 'CJ26-AzureRM'

  Prefix: 'tunis'
  ReleaseEnvironmentName: 'dev'
  UniqueId: '1280'

  ResourceGroupName: '$(Prefix)-$(ReleaseEnvironmentName)-$(UniqueId)-RG'
  WebAppName: '$(Prefix)-$(ReleaseEnvironmentName)-$(UniqueId)'
  SqlServerName: '$(Prefix)-sql-$(ReleaseEnvironmentName)-$(UniqueId)'
  hostingPlanName: '$(Prefix)-service-plan'

  DatabaseAdmin: 'houssem'
  DatabasePassword: '@Aa123456'
  DatabaseName: 'EmployeesDB'


stages:
# ============================================================
# Stage 1 : Build Stage
# ============================================================
- stage: Build_Stage
  displayName: 'Build Stage'
  jobs:

  # -------------------------
  # Job 1 : Build WebApp
  # -------------------------
  - job: WebApp
    displayName: 'Build Web App'
    pool:
      vmImage: 'windows-latest'

    variables:
      BuildConfiguration: release

    steps:
    - task: UseDotNet@2
      displayName: 'Install .NET 6 SDK'
      inputs:
        packageType: sdk
        version: 6.0.x

    - task: DotNetCoreCLI@2
      displayName: 'Restore'
      inputs:
        command: restore
        projects: '**/WebApp.csproj'

    - task: DotNetCoreCLI@2
      displayName: 'Build'
      inputs:
        projects: '**/WebApp.csproj'
        arguments: '--configuration $(BuildConfiguration)'

    - task: DotNetCoreCLI@2
      displayName: 'Test'
      inputs:
        command: test
        projects: '**/*UnitTest*.csproj'

    - task: DotNetCoreCLI@2
      displayName: 'Publish WebApp.zip'
      inputs:
        command: publish
        publishWebProjects: true
        arguments: '--configuration $(BuildConfiguration) --output $(Build.ArtifactStagingDirectory)'
        zipAfterPublish: true

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact: drop'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: drop


  # -------------------------
  # Job 2 : Build Database (DACPAC)
  # -------------------------
  - job: Database
    displayName: 'Build Database'
    pool:
      vmImage: 'windows-latest'

    steps:
    - powershell: |
        $proj = "$(Build.SourcesDirectory)\WebApp.Database\WebApp.Database.sqlproj"

        $content = Get-Content -Raw -Encoding UTF8 $proj
        $new = $content
        $new = [regex]::Replace($new, "v4\.5(\.\d)?", "v4.8")
        $new = [regex]::Replace($new, "(?<=>)4\.5(\.\d)?(?=<)", "4.8")

        if ($new -ne $content) {
          Set-Content -Path $proj -Value $new -Encoding UTF8
          Write-Host "✅ Patched sqlproj framework references to v4.8"
        }
      displayName: 'Patch SQLProj TargetFramework'

    - task: MSBuild@1
      displayName: 'Build Database.sqlproj'
      inputs:
        solution: WebApp.Database/WebApp.Database.sqlproj
        msbuildArguments: '/p:OutDir=$(Build.ArtifactStagingDirectory)'

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact: dacpac'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: dacpac


  # -------------------------
  # Job 3 : Publish ARM Templates
  # -------------------------
  - job: Infrastructure
    displayName: 'Publish ARM Templates'
    pool:
      vmImage: 'ubuntu-latest'

    steps:
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact: arm'
      inputs:
        PathtoPublish: AzureResourceGroupDeployment
        ArtifactName: arm



# ============================================================
# Stage 2 : Deploy to Dev
# ============================================================
- stage: Dev_Stage
  displayName: 'Deploy to DEV'
  dependsOn: Build_Stage
  jobs:

  # -------------------------
  # Job 1 : Deploy ARM Infra
  # -------------------------
  - job: Create_DEV
    displayName: 'Deploy ARM Infrastructure'
    pool:
      vmImage: 'windows-latest'

    steps:
    - checkout: none

    - task: DownloadBuildArtifacts@0
      displayName: 'Download ARM Templates'
      inputs:
        artifactName: arm
        downloadPath: '$(System.DefaultWorkingDirectory)'

    - task: AzureResourceGroupDeployment@2
      displayName: 'Deploy ARM Templates'
      inputs:
        azureSubscription: '$(AzureServiceConnection)'
        action: 'Create Or Update Resource Group'
        resourceGroupName: '$(ResourceGroupName)'
        location: 'West Europe'
        templateLocation: 'Linked artifact'
        csmFile: '$(System.DefaultWorkingDirectory)/arm/WebSiteSQLDatabase.json'
        csmParametersFile: '$(System.DefaultWorkingDirectory)/arm/WebSiteSQLDatabase.parameters.json'
        deploymentMode: 'Incremental'


  # -------------------------
  # Job 2 : Deploy WebApp + Database
  # -------------------------
  - job: Deploy_DEV
    displayName: 'Deploy WebApp + Database'
    dependsOn: Create_DEV
    pool:
      vmImage: 'windows-latest'

    steps:
    - checkout: none

    - task: DownloadBuildArtifacts@0
      displayName: 'Download WebApp.zip'
      inputs:
        artifactName: drop
        downloadPath: '$(System.DefaultWorkingDirectory)'

    - task: AzureRmWebAppDeployment@4
      displayName: 'Deploy WebApp'
      inputs:
        azureSubscription: '$(AzureServiceConnection)'
        appType: webApp
        WebAppName: '$(WebAppName)'
        Package: '$(System.DefaultWorkingDirectory)/drop/WebApp.zip'

    - task: DownloadBuildArtifacts@0
      displayName: 'Download DACPAC'
      inputs:
        artifactName: dacpac
        downloadPath: '$(System.DefaultWorkingDirectory)'

    - task: SqlAzureDacpacDeployment@1
      displayName: 'Deploy Database'
      inputs:
        azureSubscription: '$(AzureServiceConnection)'
        AuthenticationType: server
        ServerName: '$(SqlServerName).database.windows.net,1433'
        DatabaseName: '$(DatabaseName)'
        SqlUsername: '$(DatabaseAdmin)'
        SqlPassword: '$(DatabasePassword)'
        deployType: DacpacTask
        DeploymentAction: Publish
        DacpacFile: '$(System.DefaultWorkingDirectory)/dacpac/WebApp.Database.dacpac'
        IpDetectionMethod: AutoDetect
